---
#  Run this playbook on a fresh VM with root user having password-base SSH access to VM
# to create admin user and deploy user and disable password SSH authentication
- name: Create admin user and disable password authentication
  hosts: all
  become: true
  remote_user: root
  roles:
  - geerlingguy.docker
  tasks:
    - name: Ensure new user exists
      ansible.builtin.user:
        name: "{{ admin_user }}"
        group: sudo
        shell: /bin/bash
        state: present

    - name: Configure passwordless sudo for user
      ansible.builtin.copy:
        dest: "/etc/sudoers.d/{{ admin_user }}"
        content: "{{ admin_user }} ALL=(ALL) NOPASSWD:ALL"
        owner: root
        group: root
        mode: '0440'

    - name: Ensure .ssh directory exists
      ansible.builtin.file:
        path: "/home/{{ admin_user }}/.ssh"
        state: directory
        owner: "{{ admin_user }}"
        group: "{{ admin_user }}"
        mode: '0700'

    - name: Add authorized key for new user
      ansible.builtin.authorized_key:
        user: "{{ admin_user }}"
        key: "{{ admin_user_pub_key_path }}"

    - name: Disable root SSH login
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PermitRootLogin'
        line: 'PermitRootLogin no'
        state: present
        backup: yes

    - name: Disable password authentication
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^PasswordAuthentication'
        line: 'PasswordAuthentication no'
        state: present
        backup: yes

    - name: Restart SSH service
      ansible.builtin.service:
        name: sshd
        state: restarted

    - name: Ensure deploy user's group is created
      ansible.builtin.group:
        name: "{{ deploy_user }}"
        state: present

    - name: Ensure the deploy user is created
      ansible.builtin.user:
        name: "{{ deploy_user }}"
        groups:
          - "{{ deploy_user }}"
          - docker
        shell: /bin/bash
        state: present

    - name: Add the public key to the deploy user's authorized_keys
      ansible.builtin.authorized_key:
        user: "{{ deploy_user }}"
        key: "{{ deploy_user_pub_key_path }}"
